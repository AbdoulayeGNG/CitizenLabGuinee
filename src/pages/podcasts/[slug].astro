---
import Layout from "~/layouts/PageLayout.astro";
import type { Podcast } from "~/types/podcasts";
import { getPodcastPosts, extractAudioUrl } from "~/utils/api";

/* ðŸ”´ getStaticPaths DOIT ÃŠTRE TOUT EN HAUT */
export async function getStaticPaths() {
  const posts = await getPodcastPosts();

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

/* âœ… Ensuite seulement */
const { post } = Astro.props;

const podcast: Podcast = {
  id: post.id,
  slug: post.slug,
  title: post.title,
  episode: post.categories?.nodes?.[0]?.name ?? "Episode",
  date: new Date(post.date).toLocaleDateString("fr-FR"),
  category: post.categories?.nodes?.[0]?.name ?? "Podcast",
  description: post.excerpt?.replace(/<[^>]+>/g, ""),
  audioHtml: extractAudioUrl(post.content) ?? "",
  coverImage: post.featuredImage?.node?.mediaItemUrl ?? "",
};
---

<Layout
  metadata={{
    title: podcast.title,
    description: podcast.description,
  }}
>
  <section class="max-w-4xl mx-auto py-20 px-6">
    <h1 class="text-4xl font-bold text-green-900 mb-4">
      {podcast.title}
    </h1>

    <p class="text-gray-500 mb-6">
      {podcast.date} Â· {podcast.category}
    </p>

    {podcast.coverImage && (
      <img
        src={podcast.coverImage}
        alt={podcast.title}
        class="rounded-xl mb-8"
      />
    )}

    <div class="prose max-w-none mb-10">
      <Fragment set:html={podcast.description} />
    </div>

    <div class="mt-6">
      <Fragment set:html={podcast.audioHtml} />
    </div>
  </section>
</Layout>
